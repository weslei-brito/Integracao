<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Fichas Documentais - API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
            padding-bottom: 50px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .form-label {
            font-weight: 500;
        }
        .table th {
            background-color: #e9ecef;
        }
        .status-success {
            color: #28a745;
            font-weight: bold;
        }
        .status-error {
            color: #dc3545;
            font-weight: bold;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .file-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .file-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .badge-file {
            background-color: #6c757d;
            color: white;
            margin-right: 5px;
        }
        .api-url {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            margin-bottom: 10px;
            word-break: break-all;
        }
        .pdf-viewer {
            width: 100%;
            height: 600px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .pdf-container {
            margin-top: 15px;
        }
        .preview-buttons {
            margin-top: 10px;
        }
        .arquivo-info {
            font-size: 0.85rem;
            color: #666;
        }
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .pagination-info {
            font-weight: 500;
            color: #495057;
        }
        .pagination-controls {
            display: flex;
            gap: 5px;
        }
        .pagination-btn {
            padding: 5px 12px;
            border: 1px solid #dee2e6;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pagination-btn:hover:not(:disabled) {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .pagination-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .page-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .page-input {
            width: 70px;
            text-align: center;
        }
        .pagination-jump {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">Consulta de Fichas Documentais - API</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">URL da API:</label>
                                    <div class="api-url" id="apiUrl">http://localhost:62939/FichaDocumental/Consulta</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary" onclick="gerarCurl()">Gerar cURL</button>
                                    <button class="btn btn-outline-secondary" onclick="gerarJsonTeste()">JSON de Teste</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Filtros de Consulta</h5>
                    </div>
                    <div class="card-body">
                        <form id="consultaForm">
                            <div class="mb-3">
                                <label for="username" class="form-label">Usuário *</label>
                                <input type="text" class="form-control" id="username" placeholder="Ex: adm_wsb" required>
                            </div>
                            <div class="mb-3">
                                <label for="senha" class="form-label">Senha *</label>
                                <input type="password" class="form-control" id="senha" placeholder="Ex: senha1213" required>
                            </div>
                            
                            <h6 class="mt-4 mb-3">Filtros Básicos</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="idUnidade" class="form-label">Unidade (Filial)</label>
                                    <input type="number" class="form-control" id="idUnidade" placeholder="Ex: 70">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="idArea" class="form-label">Área (Departamento)</label>
                                    <input type="number" class="form-control" id="idArea" placeholder="Ex: 29">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="idDocumentoTipo" class="form-label">Tipo Documental</label>
                                    <input type="number" class="form-control" id="idDocumentoTipo" placeholder="Ex: 1">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="idDocumentoSubtipo" class="form-label">Subtipo Documental</label>
                                    <input type="number" class="form-control" id="idDocumentoSubtipo" placeholder="Ex: 2">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="codigoRegistro" class="form-label">Código do Registro</label>
                                <input type="number" class="form-control" id="codigoRegistro" placeholder="Ex: 1001">
                            </div>
                            
                            <div class="mb-3">
                                <label for="idDocumento" class="form-label">ID do Documento</label>
                                <input type="text" class="form-control" id="idDocumento" placeholder="Ex: CT-001-2024">
                            </div>
                            
                            <h6 class="mt-4 mb-3">Filtros de Data</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="dataInicial" class="form-label">Data Inicial</label>
                                    <input type="date" class="form-control" id="dataInicial">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="dataFinal" class="form-label">Data Final</label>
                                    <input type="date" class="form-control" id="dataFinal">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="dataCadastroInicial" class="form-label">Data Cadastro Inicial</label>
                                    <input type="date" class="form-control" id="dataCadastroInicial">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="dataCadastroFinal" class="form-label">Data Cadastro Final</label>
                                    <input type="date" class="form-control" id="dataCadastroFinal">
                                </div>
                            </div>
                            
                            <h6 class="mt-4 mb-3">Campos Customizados</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="cm01" class="form-label">CM01</label>
                                    <input type="text" class="form-control" id="cm01" placeholder="Valor do campo 01">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="cm02" class="form-label">CM02</label>
                                    <input type="text" class="form-control" id="cm02" placeholder="Valor do campo 02">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="cm03" class="form-label">CM03</label>
                                    <input type="text" class="form-control" id="cm03" placeholder="Valor do campo 03">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="cm04" class="form-label">CM04</label>
                                    <input type="text" class="form-control" id="cm04" placeholder="Valor do campo 04">
                                </div>
                            </div>
                            
                            <h6 class="mt-4 mb-3">Configuração de Paginação</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="pagina" class="form-label">Página Inicial</label>
                                    <input type="number" class="form-control" id="pagina" value="1" min="1">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="tamanhoPagina" class="form-label">Registros por Página</label>
                                    <select class="form-control" id="tamanhoPagina">
                                        <option value="5">5 registros</option>
                                        <option value="10" selected>10 registros</option>
                                        <option value="20">20 registros</option>
                                        <option value="50">50 registros</option>
                                        <option value="100">100 registros</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 mt-4">
                                <button type="button" class="btn btn-primary" onclick="consultarAPI()">
                                    <span id="btnText">Consultar API</span>
                                    <span id="btnLoading" class="spinner-border spinner-border-sm" style="display: none;"></span>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="limparFiltros()">Limpar Filtros</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Resultados da Consulta</h5>
                    </div>
                    <div class="card-body">
                        <div id="loading" class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-2">Consultando API...</p>
                        </div>
                        
                        <div id="resultadoContainer" style="display: none;">
                            <div class="alert" id="statusAlert">
                                <strong id="statusTitle">Status:</strong> <span id="statusText"></span>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>Resumo da Consulta</h6>
                                            <p><strong>Total de Registros:</strong> <span id="totalRegistros">0</span></p>
                                            <p><strong>Página Atual:</strong> <span id="paginaAtual">1</span> de <span id="totalPaginas">1</span></p>
                                            <p><strong>Registros na Página:</strong> <span id="registrosPagina">0</span></p>
                                            <p><strong>Tempo de Resposta:</strong> <span id="tempoResposta">0</span>ms</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>JSON da Requisição</h6>
                                            <textarea id="jsonEnviado" class="form-control" rows="3" readonly style="font-size: 12px;"></textarea>
                                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="copiarJson()">Copiar JSON</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Controles de Paginação (serão preenchidos dinamicamente) -->
                            <div id="paginacaoContainer" class="pagination-container" style="display: none;">
                                <div class="pagination-info">
                                    Mostrando página <span id="infoPaginaAtual">1</span> de <span id="infoTotalPaginas">1</span>
                                    | <span id="infoRegistros">0</span> registros
                                </div>
                                <div class="pagination-controls">
                                    <button class="pagination-btn" onclick="irParaPagina(1)" id="btnPrimeira" title="Primeira página">
                                        <i class="fas fa-angle-double-left"></i>
                                    </button>
                                    <button class="pagination-btn" onclick="paginaAnterior()" id="btnAnterior" title="Página anterior">
                                        <i class="fas fa-angle-left"></i>
                                    </button>
                                    
                                    <div class="pagination-jump">
                                        <span>Página</span>
                                        <input type="number" class="form-control form-control-sm page-input" id="inputPagina" min="1" value="1">
                                        <span>de <span id="maxPaginas">1</span></span>
                                        <button class="btn btn-sm btn-primary" onclick="irParaPaginaInput()">
                                            <i class="fas fa-arrow-right"></i>
                                        </button>
                                    </div>
                                    
                                    <button class="pagination-btn" onclick="proximaPagina()" id="btnProxima" title="Próxima página">
                                        <i class="fas fa-angle-right"></i>
                                    </button>
                                    <button class="pagination-btn" onclick="irParaPagina(-1)" id="btnUltima" title="Última página">
                                        <i class="fas fa-angle-double-right"></i>
                                    </button>
                                </div>
                                <div class="page-input-container">
                                    <span>Itens por página:</span>
                                    <select class="form-control form-control-sm" id="selectItensPagina" onchange="alterarItensPorPagina()">
                                        <option value="5">5</option>
                                        <option value="10" selected>10</option>
                                        <option value="20">20</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                            </div>
                            
                            <h6 class="mt-4 mb-3">Registros Encontrados</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tabelaResultados">
                                    <thead>
                                        <tr>
                                            <th>Código</th>
                                            <th>Filial</th>
                                            <th>Departamento</th>
                                            <th>Tipo</th>
                                            <th>Data Inicial</th>
                                            <th>Data Final</th>
                                            <th>Arquivos</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaBody">
                                        <!-- Dados serão inseridos aqui via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4" id="detalhesContainer" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">Detalhes do Registro</h5>
                    </div>
                    <div class="card-body">
                        <div id="detalhesConteudo">
                            <!-- Detalhes serão inseridos aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para visualizar arquivos -->
    <div class="modal fade" id="arquivosModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Arquivos do Registro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="arquivosLista">
                        <!-- Lista de arquivos será inserida aqui -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para visualizar PDF -->
    <div class="modal fade" id="pdfModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pdfModalTitle">Visualizador de PDF</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="pdfContainer">
                        <!-- PDF será carregado aqui -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="btnDownloadPdf">Download</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script>
        // URL base da API
        const API_URL = 'http://localhost:62939/FichaDocumental/Consulta';
        
        // Variáveis para controle de paginação
        let respostaAtual = null;
        let pdfUrlAtual = null;
        let nomeArquivoAtual = null;
        let paginaAtual = 1;
        let totalPaginas = 1;
        let tamanhoPagina = 10;
        let totalRegistros = 0;
        
        // Função para consultar a API
        async function consultarAPI(pagina = null) {
            // Validar campos obrigatórios
            const username = document.getElementById('username').value;
            const senha = document.getElementById('senha').value;
            
            if (!username || !senha) {
                alert('Por favor, preencha usuário e senha');
                return;
            }
            
            // Obter página atual (se não for fornecida)
            if (pagina === null) {
                pagina = parseInt(document.getElementById('pagina').value) || 1;
            }
            
            // Atualizar variáveis de paginação
            paginaAtual = pagina;
            tamanhoPagina = parseInt(document.getElementById('tamanhoPagina').value) || 10;
            
            // Mostrar loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultadoContainer').style.display = 'none';
            document.getElementById('paginacaoContainer').style.display = 'none';
            document.getElementById('btnText').style.display = 'none';
            document.getElementById('btnLoading').style.display = 'inline-block';
            
            // Coletar dados do formulário
            const dados = {
                username: username,
                senha: senha,
                idUnidade: document.getElementById('idUnidade').value || null,
                idArea: document.getElementById('idArea').value || null,
                idDocumentoTipo: document.getElementById('idDocumentoTipo').value || null,
                idDocumentoSubtipo: document.getElementById('idDocumentoSubtipo').value || null,
                codigoRegistro: document.getElementById('codigoRegistro').value || null,
                idDocumento: document.getElementById('idDocumento').value || null,
                dataInicial: document.getElementById('dataInicial').value || null,
                dataFinal: document.getElementById('dataFinal').value || null,
                dataCadastroInicial: document.getElementById('dataCadastroInicial').value || null,
                dataCadastroFinal: document.getElementById('dataCadastroFinal').value || null,
                cm01: document.getElementById('cm01').value || null,
                cm02: document.getElementById('cm02').value || null,
                cm03: document.getElementById('cm03').value || null,
                cm04: document.getElementById('cm04').value || null,
                pagina: paginaAtual,
                tamanhoPagina: tamanhoPagina
            };
            
            // Remover campos nulos
            Object.keys(dados).forEach(key => {
                if (dados[key] === null || dados[key] === '') {
                    delete dados[key];
                }
            });
            
            // Exibir JSON enviado
            document.getElementById('jsonEnviado').value = JSON.stringify(dados, null, 2);
            
            try {
                const inicio = Date.now();
                
                // Fazer requisição POST para a API
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dados)
                });
                
                const tempoResposta = Date.now() - inicio;
                const resultado = await response.json();
                
                respostaAtual = resultado;
                totalRegistros = resultado.totalRegistros || 0;
                
                // Calcular total de páginas
                totalPaginas = Math.ceil(totalRegistros / tamanhoPagina);
                if (totalPaginas === 0) totalPaginas = 1;
                
                // Ajustar página atual se necessário
                if (paginaAtual > totalPaginas) {
                    paginaAtual = totalPaginas;
                }
                
                // Esconder loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('resultadoContainer').style.display = 'block';
                document.getElementById('btnText').style.display = 'inline-block';
                document.getElementById('btnLoading').style.display = 'none';
                
                // Atualizar informações da consulta
                document.getElementById('totalRegistros').textContent = totalRegistros;
                document.getElementById('paginaAtual').textContent = paginaAtual;
                document.getElementById('totalPaginas').textContent = totalPaginas;
                document.getElementById('registrosPagina').textContent = resultado.registros ? resultado.registros.length : 0;
                document.getElementById('tempoResposta').textContent = tempoResposta;
                
                // Atualizar status alert
                const statusAlert = document.getElementById('statusAlert');
                const statusText = document.getElementById('statusText');
                
                if (resultado.sucesso) {
                    statusAlert.className = 'alert alert-success';
                    statusText.textContent = resultado.mensagem || 'Consulta realizada com sucesso';
                    statusText.className = 'status-success';
                } else {
                    statusAlert.className = 'alert alert-danger';
                    statusText.textContent = resultado.mensagem || 'Erro na consulta';
                    statusText.className = 'status-error';
                }
                
                // Atualizar controles de paginação
                atualizarControlesPaginacao();
                
                // Preencher tabela com resultados
                preencherTabela(resultado.registros);
                
            } catch (error) {
                console.error('Erro na consulta:', error);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('resultadoContainer').style.display = 'block';
                document.getElementById('btnText').style.display = 'inline-block';
                document.getElementById('btnLoading').style.display = 'none';
                
                document.getElementById('statusAlert').className = 'alert alert-danger';
                document.getElementById('statusText').textContent = `Erro: ${error.message}`;
                document.getElementById('statusText').className = 'status-error';
                document.getElementById('totalRegistros').textContent = '0';
            }
        }
        
        // Função para atualizar controles de paginação
        function atualizarControlesPaginacao() {
            const paginacaoContainer = document.getElementById('paginacaoContainer');
            const infoPaginaAtual = document.getElementById('infoPaginaAtual');
            const infoTotalPaginas = document.getElementById('infoTotalPaginas');
            const infoRegistros = document.getElementById('infoRegistros');
            const inputPagina = document.getElementById('inputPagina');
            const maxPaginas = document.getElementById('maxPaginas');
            const btnPrimeira = document.getElementById('btnPrimeira');
            const btnAnterior = document.getElementById('btnAnterior');
            const btnProxima = document.getElementById('btnProxima');
            const btnUltima = document.getElementById('btnUltima');
            const selectItensPagina = document.getElementById('selectItensPagina');
            
            // Atualizar informações
            infoPaginaAtual.textContent = paginaAtual;
            infoTotalPaginas.textContent = totalPaginas;
            infoRegistros.textContent = totalRegistros;
            inputPagina.value = paginaAtual;
            inputPagina.max = totalPaginas;
            maxPaginas.textContent = totalPaginas;
            
            // Atualizar select de itens por página
            selectItensPagina.value = tamanhoPagina;
            
            // Atualizar estado dos botões
            btnPrimeira.disabled = paginaAtual <= 1;
            btnAnterior.disabled = paginaAtual <= 1;
            btnProxima.disabled = paginaAtual >= totalPaginas;
            btnUltima.disabled = paginaAtual >= totalPaginas;
            
            // Mostrar controles de paginação se houver mais de uma página
            if (totalPaginas > 1 || totalRegistros > tamanhoPagina) {
                paginacaoContainer.style.display = 'flex';
            } else {
                paginacaoContainer.style.display = 'none';
            }
        }
        
        // Função para ir para página específica
        function irParaPagina(pagina) {
            if (pagina === -1) {
                // Última página
                consultarAPI(totalPaginas);
            } else if (pagina >= 1 && pagina <= totalPaginas) {
                consultarAPI(pagina);
            }
        }
        
        // Função para navegar para página a partir do input
        function irParaPaginaInput() {
            const input = document.getElementById('inputPagina');
            const pagina = parseInt(input.value);
            
            if (pagina >= 1 && pagina <= totalPaginas) {
                consultarAPI(pagina);
            } else {
                alert(`Por favor, insira um número de página entre 1 e ${totalPaginas}`);
                input.value = paginaAtual;
            }
        }
        
        // Função para página anterior
        function paginaAnterior() {
            if (paginaAtual > 1) {
                consultarAPI(paginaAtual - 1);
            }
        }
        
        // Função para próxima página
        function proximaPagina() {
            if (paginaAtual < totalPaginas) {
                consultarAPI(paginaAtual + 1);
            }
        }
        
        // Função para alterar número de itens por página
        function alterarItensPorPagina() {
            const novoValor = parseInt(document.getElementById('selectItensPagina').value);
            
            // Atualizar select no formulário principal
            document.getElementById('tamanhoPagina').value = novoValor;
            
            // Voltar para página 1 e fazer nova consulta
            document.getElementById('pagina').value = 1;
            consultarAPI(1);
        }
        
        // Função para preencher a tabela com resultados
        function preencherTabela(registros) {
            const tabelaBody = document.getElementById('tabelaBody');
            tabelaBody.innerHTML = '';
            
            if (!registros || registros.length === 0) {
                tabelaBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">Nenhum registro encontrado</td>
                    </tr>
                `;
                return;
            }
            
            registros.forEach(registro => {
                const dataInicial = registro.dataInicial ? new Date(registro.dataInicial).toLocaleDateString('pt-BR') : '-';
                const dataFinal = registro.dataFinal ? new Date(registro.dataFinal).toLocaleDateString('pt-BR') : '-';
                const totalArquivos = registro.arquivos ? registro.arquivos.length : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${registro.codigoRegistro}</strong></td>
                    <td>${registro.filial || '-'}</td>
                    <td>${registro.departamento || '-'}</td>
                    <td>${registro.tipo || '-'}</td>
                    <td>${dataInicial}</td>
                    <td>${dataFinal}</td>
                    <td>
                        ${totalArquivos > 0 
                            ? `<span class="badge bg-primary">${totalArquivos} arquivo(s)</span>` 
                            : '<span class="badge bg-secondary">Sem arquivos</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="verDetalhes(${registro.codigoRegistro})">
                            Detalhes
                        </button>
                        ${totalArquivos > 0 
                            ? `<button class="btn btn-sm btn-outline-info" onclick="verArquivos(${registro.codigoRegistro})">
                                Ver Arquivos
                               </button>` 
                            : ''}
                    </td>
                `;
                tabelaBody.appendChild(row);
            });
        }
        
        // Função para ver detalhes de um registro
        function verDetalhes(codigoRegistro) {
            const registro = respostaAtual.registros.find(r => r.codigoRegistro == codigoRegistro);
            
            if (!registro) return;
            
            const detalhesConteudo = document.getElementById('detalhesConteudo');
            const dataCadastro = registro.dataCadastro ? new Date(registro.dataCadastro).toLocaleString('pt-BR') : '-';
            const dataInicial = registro.dataInicial ? new Date(registro.dataInicial).toLocaleDateString('pt-BR') : '-';
            const dataFinal = registro.dataFinal ? new Date(registro.dataFinal).toLocaleDateString('pt-BR') : '-';
            
            detalhesConteudo.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Informações Básicas</h6>
                        <p><strong>Código:</strong> ${registro.codigoRegistro}</p>
                        <p><strong>Filial:</strong> ${registro.filial || '-'}</p>
                        <p><strong>Departamento:</strong> ${registro.departamento || '-'}</p>
                        <p><strong>Tipo:</strong> ${registro.tipo || '-'}</p>
                        <p><strong>Subitem:</strong> ${registro.subitem || '-'}</p>
                        <p><strong>ID Documento:</strong> ${registro.idDocumento || '-'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Datas e Informações</h6>
                        <p><strong>Data Inicial:</strong> ${dataInicial}</p>
                        <p><strong>Data Final:</strong> ${dataFinal}</p>
                        <p><strong>Data Cadastro:</strong> ${dataCadastro}</p>
                        <p><strong>Observação:</strong> ${registro.observacao || '-'}</p>
                        <p><strong>Total de Imagens:</strong> ${registro.totalImagens || 0}</p>
                        <p><strong>Indexador:</strong> ${registro.indexador || '-'}</p>
                    </div>
                </div>
                
                <h6 class="mt-4">Campos Customizados</h6>
                <div class="row">
                    <div class="col-md-3">
                        <p><strong>CM01:</strong> ${registro.cm01 || '-'}</p>
                    </div>
                    <div class="col-md-3">
                        <p><strong>CM02:</strong> ${registro.cm02 || '-'}</p>
                    </div>
                    <div class="col-md-3">
                        <p><strong>CM03:</strong> ${registro.cm03 || '-'}</p>
                    </div>
                    <div class="col-md-3">
                        <p><strong>CM04:</strong> ${registro.cm04 || '-'}</p>
                    </div>
                </div>
                
                <div class="mt-4">
                    <button class="btn btn-sm btn-outline-secondary" onclick="fecharDetalhes()">
                        Fechar Detalhes
                    </button>
                </div>
            `;
            
            document.getElementById('detalhesContainer').style.display = 'block';
        }
        
        // Função para ver arquivos de um registro
        function verArquivos(codigoRegistro) {
            const registro = respostaAtual.registros.find(r => r.codigoRegistro == codigoRegistro);
            
            if (!registro || !registro.arquivos || registro.arquivos.length === 0) return;
            
            const arquivosLista = document.getElementById('arquivosLista');
            arquivosLista.innerHTML = '<div class="file-list">';
            
            registro.arquivos.forEach((arquivo, index) => {
                const extensao = arquivo.extensaoArquivo || arquivo.nomeArquivo?.split('.').pop() || 'pdf';
                const tipoMime = arquivo.tipoMimeArquivo || 'application/pdf';
                const urlPreAssinada = arquivo.urlArquivoPreAssinada || arquivo.urlArquivo;
                
                arquivosLista.innerHTML += `
                    <div class="file-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="badge badge-file">${index + 1}</span>
                                <strong>${arquivo.nomeArquivo || 'arquivo_' + (index + 1)}</strong>
                            </div>
                            <div>
                                <span class="badge bg-info">${extensao.toUpperCase()}</span>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <p class="mb-1 arquivo-info">
                                <strong>ID Arquivo:</strong> ${arquivo.idArquivo || '-'}<br>
                                <strong>Código Registro:</strong> ${arquivo.codigoRegistro || '-'}<br>
                                <strong>Tipo MIME:</strong> ${tipoMime}<br>
                                <strong>URL Pré-Assinada:</strong> <span class="text-truncate d-inline-block" style="max-width: 300px;">${urlPreAssinada || 'N/A'}</span>
                            </p>
                        </div>
                        
                        <div class="mt-3 preview-buttons">
                            ${urlPreAssinada && tipoMime === 'application/pdf' ? `
                                <button class="btn btn-sm btn-primary" onclick="visualizarPdf('${urlPreAssinada}', '${arquivo.nomeArquivo || 'documento.pdf'}')">
                                    <i class="fas fa-eye"></i> Visualizar PDF
                                </button>
                            ` : ''}
                            
                            ${urlPreAssinada ? `
                                <a href="${urlPreAssinada}" target="_blank" class="btn btn-sm btn-success">
                                    <i class="fas fa-external-link-alt"></i> Abrir em Nova Aba
                                </a>
                                <button class="btn btn-sm btn-outline-success" onclick="copiarUrl('${urlPreAssinada}')">
                                    <i class="fas fa-copy"></i> Copiar URL
                                </button>
                                <a href="${urlPreAssinada}" download="${arquivo.nomeArquivo || 'documento.pdf'}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-download"></i> Download
                                </a>
                            ` : `
                                <button class="btn btn-sm btn-secondary" disabled>
                                    <i class="fas fa-exclamation-triangle"></i> URL não disponível
                                </button>
                            `}
                        </div>
                    </div>
                `;
            });
            
            arquivosLista.innerHTML += '</div>';
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('arquivosModal'));
            modal.show();
        }
        
        // Função para visualizar PDF
        function visualizarPdf(urlPreAssinada, nomeArquivo) {
            pdfUrlAtual = urlPreAssinada;
            nomeArquivoAtual = nomeArquivo;
            
            const pdfContainer = document.getElementById('pdfContainer');
            pdfContainer.innerHTML = `
                <div class="text-center mt-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando PDF...</span>
                    </div>
                    <p class="mt-2">Carregando PDF: ${nomeArquivo}</p>
                </div>
            `;
            
            // Atualizar título do modal
            document.getElementById('pdfModalTitle').textContent = `Visualizando: ${nomeArquivo}`;
            
            // Configurar botão de download
            document.getElementById('btnDownloadPdf').onclick = function() {
                if (pdfUrlAtual) {
                    const link = document.createElement('a');
                    link.href = pdfUrlAtual;
                    link.download = nomeArquivoAtual;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };
            
            // Mostrar modal
            const pdfModal = new bootstrap.Modal(document.getElementById('pdfModal'));
            pdfModal.show();
            
            // Carregar PDF no iframe após um breve delay
            setTimeout(() => {
                pdfContainer.innerHTML = `
                    <iframe 
                        src="${urlPreAssinada}" 
                        class="pdf-viewer"
                        frameborder="0"
                        title="Visualizador de PDF - ${nomeArquivo}"
                    ></iframe>
                    <div class="mt-2 text-center">
                        <p class="text-muted">Se o PDF não carregar automaticamente, <a href="${urlPreAssinada}" target="_blank">clique aqui para abrir em nova aba</a></p>
                    </div>
                `;
            }, 500);
        }
        
        // Função para copiar URL
        function copiarUrl(url) {
            navigator.clipboard.writeText(url)
                .then(() => {
                    const originalText = event.target.innerHTML;
                    event.target.innerHTML = '<i class="fas fa-check"></i> Copiado!';
                    event.target.className = 'btn btn-sm btn-success';
                    
                    setTimeout(() => {
                        event.target.innerHTML = originalText;
                        event.target.className = 'btn btn-sm btn-outline-success';
                    }, 2000);
                })
                .catch(err => {
                    console.error('Erro ao copiar URL:', err);
                    alert('Erro ao copiar URL: ' + err.message);
                });
        }
        
        // Função para copiar JSON
        function copiarJson() {
            const jsonText = document.getElementById('jsonEnviado').value;
            navigator.clipboard.writeText(jsonText)
                .then(() => alert('JSON copiado com sucesso!'))
                .catch(err => console.error('Erro ao copiar JSON:', err));
        }
        
        // Função para fechar detalhes
        function fecharDetalhes() {
            document.getElementById('detalhesContainer').style.display = 'none';
        }
        
        // Função para limpar filtros
        function limparFiltros() {
            document.getElementById('consultaForm').reset();
            document.getElementById('resultadoContainer').style.display = 'none';
            document.getElementById('detalhesContainer').style.display = 'none';
            document.getElementById('paginacaoContainer').style.display = 'none';
            respostaAtual = null;
            paginaAtual = 1;
        }
        
        // Função para gerar comando cURL
        function gerarCurl() {
            const username = document.getElementById('username').value || 'seu_usuario';
            const senha = document.getElementById('senha').value || 'sua_senha';
            const jsonEnviado = document.getElementById('jsonEnviado').value;
            
            let jsonData = {};
            try {
                jsonData = JSON.parse(jsonEnviado) || {};
            } catch (e) {
                jsonData = {
                    username: username,
                    senha: senha,
                    idUnidade: 70,
                    idArea: 29,
                    pagina: 1,
                    tamanhoPagina: 10
                };
            }
            
            const curlCommand = `curl -X POST ${API_URL} \\
  -H "Content-Type: application/json" \\
  -d '${JSON.stringify(jsonData)}'`;
            
            alert('Comando cURL gerado! Copie do console ou do alerta.');
            console.log('Comando cURL:');
            console.log(curlCommand);
            
            const win = window.open('', '_blank');
            win.document.write('<pre>' + curlCommand + '</pre>');
            win.document.close();
        }
        
        // Função para gerar JSON de teste
        function gerarJsonTeste() {
            const jsonTeste = {
                username: "adm_wsb",
                senha: "senha1213",
                idUnidade: 70,
                idArea: 29,
                idDocumentoTipo: 1,
                pagina: 1,
                tamanhoPagina: 10
            };
            
            document.getElementById('username').value = jsonTeste.username;
            document.getElementById('senha').value = jsonTeste.senha;
            document.getElementById('idUnidade').value = jsonTeste.idUnidade;
            document.getElementById('idArea').value = jsonTeste.idArea;
            document.getElementById('idDocumentoTipo').value = jsonTeste.idDocumentoTipo;
            document.getElementById('pagina').value = jsonTeste.pagina;
            document.getElementById('tamanhoPagina').value = jsonTeste.tamanhoPagina;
            
            document.getElementById('jsonEnviado').value = JSON.stringify(jsonTeste, null, 2);
            
            alert('JSON de teste carregado! Ajuste os valores se necessário.');
        }
        
        // Permitir enviar com Enter no formulário
        document.getElementById('consultaForm').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                consultarAPI();
            }
        });
        
        // Inicializar com JSON de exemplo
        window.onload = function() {
            gerarJsonTeste();
        };
    </script>
</body>
</html>
